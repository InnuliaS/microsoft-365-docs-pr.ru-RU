---
title: Самостоятельная регистрация существующих устройств
description: Регистрация повторно используемых устройств. возможно, у вас уже есть права для управления на настольном компьютере, управляемом Майкрософт
ms.prod: w10
author: jaimeo
ms.author: jaimeo
ms.localizationpriority: medium
ms.openlocfilehash: 8d2bc20a1d429510dfcd651c6b15dc1a2a89de9d
ms.sourcegitcommit: b65c80051e53d9be223f4769f4d42a39f5a07735
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2019
ms.locfileid: "39962606"
---
# <a name="register-existing-devices-yourself"></a>Самостоятельная регистрация существующих устройств

>[!NOTE]
>В этом разделе описываются действия, которые необходимо выполнить, чтобы повторно использовать уже имеющиеся устройства и зарегистрировать их в системе, управляемой корпорацией Майкрософт. Если вы работаете с новыми устройствами, выполните действия, описанные в статье [Регистрация новых устройств на компьютере, управляемом Майкрософт](register-devices-self.md) , вместо этого.

Процесс для партнеров описан в [статье действия для партнеров по регистрации устройств](register-devices-partner.md).

Рабочий стол, управляемый Майкрософт, может работать с новыми устройствами или можно повторно использовать уже имеющиеся устройства (которые потребуют их повторного создания образа). Вы можете зарегистрировать устройства с помощью управляемого рабочего стола Майкрософт на портале Azure.

## <a name="prepare-to-register-existing-devices"></a>Подготовка к регистрации существующих устройств


Чтобы зарегистрировать существующие устройства, выполните указанные ниже действия.

1. [Получите хеш оборудования для каждого устройства.](#obtain-the-hardware-hash)
2. [Объединение хэш-данных](#merge-hash-data)
3. [Зарегистрируйте устройства на настольном компьютере, управляемом Майкрософт](#register-devices).
4. [Дважды проверьте правильность изображения.](#check-the-image)
5. [Доставка устройства](#deliver-the-device)

### <a name="obtain-the-hardware-hash"></a>Получение хэш-кода оборудования

Рабочий стол, управляемый Майкрософт, определяет каждое устройство уникальным образом, ссылаясь на хэш оборудования. Существует четыре способа получения этой информации с устройств, которые вы уже используете:

- Обратитесь к поставщику поставщика вычислительной техники для файла регистрации для автопилота, в котором будут содержаться хэши оборудования.
- Создание настраиваемого отчета в [диспетчере конфигураций](#configuration-manager).
- Запустите сценарий Windows PowerShell, используя [Active Directory](#active-directory-powershell-script-method) или [вручную](#manual-powershell-script-method) на каждом устройстве, и соберите результаты в файл.
- Запустите каждое устройство, но не завершите работу с программой установки Windows, и [Соберите хэши на съемном носителе флэш-памяти](#flash-drive-method).

#### <a name="configuration-manager"></a>Configuration Manager

С помощью System Center Configuration Manager можно собирать аппаратные хэши с существующих устройств, которые вы хотите зарегистрировать с помощью управляемого рабочего стола Майкрософт.

> [!IMPORTANT]
> Все устройства, для которых вы хотите получить эту информацию, должны работать под управлением Windows 10 версии 1703 или более поздней. Кроме того, вам потребуется устройство, которое является клиентом Configuration Manager, подключенным к текущему узлу филиала System Center. Кроме того, необходимо настроить роль системы сайта точки формирования отчетов в среде с включенными службами SQL Server Reporting Services. 

Если вы удовлетворены всеми необходимыми компонентами, вы готовы собрать эти сведения, выполнив указанные ниже действия.

1. В консоли диспетчера конфигураций выберите пункт **мониторинг**. 
2. В рабочей области мониторинга разверните узел **отчеты**, а затем выберите пункт **отчеты**. 
3. На вкладке **Главная** , в разделе **создать** , выберите **создать отчет** , чтобы открыть мастер создания отчетов. 
4. На странице **сведения** задайте следующие параметры: 
    - **Имя:** Укажите имя отчета. 
    - **Description:** Укажите описание отчета. 
    - **Сервер:** Отображает имя сервера отчетов, на котором создается этот отчет. 
    - **Путь:** Нажмите кнопку **Обзор** , чтобы указать папку, в которой будет храниться отчет. 
5. Нажмите кнопку **Далее**. 
6. На странице **Сводка** проверьте параметры. Нажмите кнопку **назад** , чтобы изменить параметры или нажмите кнопку **Далее** , чтобы создать отчет в Configuration Manager. 
7. На странице **Завершение** нажмите кнопку **Закрыть** , чтобы завершить работу мастера и открыть **Построитель отчетов** , чтобы ввести параметры отчета. При появлении запроса введите учетную запись пользователя и пароль, а затем нажмите кнопку **ОК.** Если на устройстве не установлен построитель отчетов, вам будет предложено установить его. Выберите **выполнить, чтобы установить построитель отчетов**, который требуется для изменения и создания отчетов. 


**В построителе отчетов Майкрософт**введите инструкцию SQL для отчета и выполните указанные ниже действия.

1. В левой области выберите **наборы**данных, а затем щелкните правой кнопкой мыши, чтобы **Добавить набор данных**.
2. Перейдите на вкладку **запрос** и введите имя в формате *DataSet0*. 
3. Выберите **использовать набор данных, внедренный в отчет**; Откроется построитель отчетов.
4. В **построителе отчетов**выберите **источник данных:**. Выберите источник данных по умолчанию, который должен начинаться с "Аутожен". 
5. Выберите **тип запроса в текстовом поле**, а затем введите следующий запрос:




```sql
SELECT comp.manufacturer0      AS Manufacturer,  
       comp.model0             AS Model,  
       bios.serialnumber0      AS Serial_Number,  
       mdm.devicehardwaredata0 AS HardwareHash  
FROM   Fn_rbac_gs_computer_system(@UserSIDs) comp

       INNER JOIN Fn_rbac_gs_pc_bios(@UserSIDs) bios  
               ON comp.resourceid = bios.resourceid  
       INNER JOIN Fn_rbac_gs_mdm_devdetail_ext01(@UserSIDs) mdm  
               ON comp.resourceid = mdm.resourceid
```




5. Перейдите на вкладку **поле** , значения Вехре для **имени поля** и **Источник поля** уже должны быть заполнены. Если это не так, нажмите кнопку **Добавить**, а затем выберите **поле запрос**. Введите **имя поля** и **Источник поля**.
6. Повторите эти значения для каждого из этих значений: 
    - Вычислитель 
    - Модель 
    - Serial_Number 
    - хардварехаш
7. Нажмите кнопку **ОК**.

**Затем определите отображение отчета и создайте отчет** , выполнив следующие действия:

1. Выберите **Таблица или матрицу**; Откроется новый мастер.
2. В окне **Выбор набора данных**выберите **выбрать существующий набор данных в этом отчете или в общем наборе данных**.  
3. Выберите **DataSet0** (по умолчанию), а затем нажмите кнопку **Далее**.
4. Перетащите **производителя**, **модель**и **серийный номер** в поле **группы строк** . Перетащите **хардварехаш** в поле **значения** , а затем нажмите кнопку **Далее**.
5. Снимите флажки для отображения промежуточных **и общих итогов** , а также **развертывания и свертывания групп**. Нажмите кнопку **Далее**.
6. Нажмите кнопку **Готово**.
7. Выберите **выполнить** , чтобы запустить отчет. Убедитесь, что отчет содержит ожидаемые сведения. При необходимости выберите **проект** , чтобы вернуться в режим конструктора, чтобы изменить отчет.
8. Нажмите кнопку **сохранить** , чтобы сохранить отчет на сервере отчетов. Новый отчет можно запустить в узле "отчеты" в рабочей области "Мониторинг". 

**Наконец, экспортируйте отчет и используйте его для регистрации устройств** , выполнив указанные ниже действия. (Вам необходимо выполнить действия 1 и 2 этого раздела, если вы выполнили переход с предыдущих шагов.):

1. В консоли диспетчера конфигураций выберите пункт **мониторинг**.
2. В **мониторинге**разверните узел **отчеты**, а затем выберите пункт **отчеты**.
3. Найдите отчет с помощью созданного ранее имени.
4. Щелкните этот отчет правой кнопкой мыши и выберите команду **выполнить**.
5. В открывшемся диалоговом окне выберите пункт **Экспорт** , а затем — **Сохранить как CSV**-файл.
6. Эта версия отчета извлекает хэши со всех устройств с Windows 10, с которыми работает Configuration Manager. Вам потребуется фильтровать результаты только на тех устройствах, которые планируется зарегистрировать с помощью управляемого рабочего стола Майкрософт.


> [!IMPORTANT]
> В запросе в диспетчере конфигурации не допускаются пробелы в именах экспортированных столбцов; Вот почему вы вводили пункты "Serial_Number" и "Хардварехаш". Теперь, когда у вас есть экспортированный CSV-файл, необходимо изменить заголовки отчетов для чтения *серийного номера* и *аппаратного хеша* , как показано ниже, прежде чем переходить к регистрации устройства.

Теперь вы можете перейти к [регистрации устройств с помощью портала Azure](#register-devices-by-using-the-azure-portal).


#### <a name="active-directory-powershell-script-method"></a>Метод сценария PowerShell Active Directory

В среде Active Directory вы можете использовать командлет `Get-MMDRegistrationInfo` PowerShell для удаленного сбора сведений от устройств в группах Active Directory с помощью WinRM. Кроме того, можно использовать `Get-AD Computer` командлеты и получать отфильтрованные результаты для определенных аппаратных имен моделей, включенных в каталог. Для этого сначала подтвердите необходимые условия, а затем выполните действия, описанные ниже.

- Служба WinRM включена.
- Устройства, которые вы хотите зарегистрировать, активны в сети (то есть они не отключены и не отключены).
- Убедитесь, что у вас есть параметр учетных данных домена, у которого есть разрешение на удаленное выполнение на устройствах.
- Убедитесь, что брандмауэр Windows предоставляет доступ к WMI. Для этого выполните указанные ниже действия.
    1. Откройте панель управления **брандмауэром защитника Windows** и выберите пункт **Разрешить приложение или компонент через брандмауэр защитника Windows**.
    2. Найдите в списке **инструментарий управления Windows (WMI)** , включите как частный, так и **общедоступный**, а затем нажмите кнопку **ОК**.

1.  Откройте командную строку PowerShell с правами администратора.
2.  Выполните *один* из следующих сценариев:
```powershell
Install-script -name Get-MMDRegistrationInfo 
#example one – leverage Get-ADComputer to enumerate devices 
Get-ADComputer -filter * | powershell -ExecutionPolicy Unrestricted Get-MMDRegistrationInfo.ps1 -credential Domainname\<accountname>
```
```powershell 
#example two – target specific devices: 
Set-ExecutionPolicy powershell -ExecutionPolicy Unrestricted Get-MMDRegistrationInfo.ps1 -credential Domainname\<accountname> -Name Machine1,Machine2,Machine3
```
3. Доступ к каталогам, в которых могут быть записи для устройств. Удалите записи для каждого устройства из *всех* каталогов, включая доменные службы Windows Server Active Directory и Azure Active Directory. Обратите внимание, что для полного выполнения этого процесса может потребоваться несколько часов.
4. Доступ к службам управления, в которых могут быть записи для устройств. Удалите записи для каждого устройства из *всех* служб управления, в том числе System Center Configuration Manager, Microsoft Intune и Windows автопилот. Обратите внимание, что для полного выполнения этого процесса может потребоваться несколько часов.

Теперь вы можете перейти к разделу [Регистрация устройств](#register-devices).

#### <a name="manual-powershell-script-method"></a>Метод сценария PowerShell вручную

1.  Откройте командную строку PowerShell с правами администратора.
2.  Выполняем`Install-Script -Name Get-MMDRegistrationInfo`
3.  Выполняем`powershell -ExecutionPolicy Unrestricted Get-MMDRegistrationInfo -OutputFile <path>\hardwarehash.csv`
4. [Объединение хэш-данных.](#merge-hash-data)

#### <a name="flash-drive-method"></a>Метод флэш-накопителя

1. На устройстве, отличном от регистрируемого, вставьте USB-накопитель.
2. Откройте командную строку PowerShell с правами администратора.
3. Выполняем`Save-Script -Name Get-MMDRegistrationInfo -Path <pathToUsb>`
4. Включите регистрируемое устройство, но не *запускайте процесс установки*. Если вы случайно запустили программу установки, вам потребуется сбросить или переобразировать устройство.
5. Вставьте USB-накопитель, а затем нажмите клавиши SHIFT + F10.
6. Откройте командную строку PowerShell с правами администратора и запустите `cd <pathToUsb>`.
7. Выполняем`Set-ExecutionPolicy -ExecutionPolicy Unrestricted`
8. Выполняем`.\Get-MMDRegistrationInfo -OutputFile <path>\hardwarehash.csv`
9. Удалите USB-накопитель, а затем завершите работу устройства, выполнив`shutdown -s -t 0`
10. [Объединение хэш-данных.](#merge-hash-data)

>[!IMPORTANT]
>Не выключайте устройство, которое вы регистрируете повторно, пока не завершите его регистрацию. 



### <a name="merge-hash-data"></a>Слияние хэш-данных

Если вы собрали хэш-данные оборудования вручную с помощью методов PowerShell или устройства флэш-памяти, то теперь необходимо объединить данные CSV-файлов в один файл для завершения регистрации. Вот пример сценария PowerShell для упрощения:

`Import-CSV -Path (Get-ChildItem -Filter *.csv) | ConvertTo-Csv -NoTypeInformation | % {$_.Replace('"', '')} | Out-File .\aggregatedDevices.csv`

После объединения хэш-данных в один CSV-файл можно приступить к [регистрации устройств](#register-devices).

### <a name="register-devices"></a>Регистрация устройств

Для регистрации CSV-файл должен быть в определенном формате. Если вы собрали данные самостоятельно на предыдущих шагах, файл должен быть уже в правильном формате; Если вы получаете файл от поставщика, может потребоваться изменить формат.

>[!NOTE]
>Для удобства вы можете скачать [шаблон](https://github.com/MicrosoftDocs/microsoft-365-docs/raw/public/microsoft-365/managed-desktop/get-started/downloads/device-registration-sample-partner.xlsx) для этого CSV-файла.

Ваш файл должен включать в себя те **же заголовки столбцов** , что и один образец (Manufacturer, Model и т. д.), но собственные данные для других строк. Если вы используете шаблон, откройте его в средстве редактирования текста (например, в Блокноте) и продумайте все данные только в строке 1, вводя данные в строки 2 и ниже. 
    
  ```
 Manufacturer,Model,Serial Number,Hardware Hash
  SpiralOrbit,ContosoABC,000000000000,dGhpc2RldmljZWlzYW5tbWRkZXZpY2U
  
  
  ```

>[!NOTE]
>Если вы забыли изменить какой – либо образец данных, регистрация завершится с ошибками.

#### <a name="register-devices-by-using-the-azure-portal"></a>Регистрация устройств с помощью портала Azure

На [портале Azure](https://aka.ms/mmdportal)с настольным управлением Microsoft выберите **устройства** в левой области навигации. Выберите **+ Регистрация устройств**; Откроется вспомогательная надстройка:

[![Вскрывающийся после выбора параметра Регистрация устройств, перечисление устройств со столбцами для назначенных пользователей, серийного номера, состояния, даты последнего рассмотрения и срока хранения](images/register-devices-flyin-sterile.png)](images/register-devices-flyin-sterile.png)


[//]: # (К сожалению, это не так. Мы можем удалить эту заметку, но оставив ее сейчас, пока не сможете поговорить с этой заметкой.)

<!--Registering any existing devices with Managed Desktop will completely re-image them; make sure you've backed up any important data prior to starting the registration process.-->


Выполните приведенные ниже действия.

1. В поле **Отправка файла**укажите путь к созданному ранее CSV-файлу.
2. При необходимости вы можете добавить **идентификатор заказа** или **идентификатор покупки** для собственных целей отслеживания. Для этих значений не предусмотрены требования к формату.
3. Выберите пункт **зарегистрировать устройства**. Система добавит устройства в список устройств в **колонке устройств**, помеченных как **ожидающие регистрации**. Регистрация обычно занимает менее 10 минут, и при успешном завершении работы устройство отображается как **готовое для пользователя** , что означает, что он готов и ждет, пока конечный пользователь начнет использовать.


Вы можете отслеживать ход регистрации устройств на главной странице " **управляемые настольные устройства Майкрософт** ". В отчет могут воздержаться следующие сведения:

| Состояние | Описание |
|---------------|-------------|
| Ожидается регистрация | Регистрация еще не выполняется. Вернитесь позже. |
| Сбой регистрации | Не удалось выполнить регистрацию. Для получения дополнительных сведений обратитесь к разделу [Устранение неполадок Device Registration](#troubleshooting-device-registration) . |
| Готово для пользователя | Регистрация выполнена успешно, и теперь устройство готово к доставке конечному пользователю. Рабочий стол, управляемый Майкрософт, будет самостоятельно настраиваться, поэтому дальнейшие подготовительные действия не требуются. |
| Активное | Устройство было доставлено конечному пользователю и зарегистрировано в клиенте. Это также означает, что они регулярно используют устройство. |
| Отсутств | Устройство было доставлено конечному пользователю и зарегистрировано в клиенте. Однако они не использовали устройство недавно (за последние 7 дней).  | 

#### <a name="troubleshooting-device-registration"></a>Устранение неполадок при регистрации устройств

| Сообщение об ошибке | Сведения |
|---------------|-------------|
| Устройство не найдено | Не удалось зарегистрировать это устройство, так как не удалось найти соответствующее значение для указанного производителя, модели или серийного номера. Подтвердите эти значения с помощью поставщика устройств. |
| Недопустимый хеш оборудования | Аппаратный хеш, указанный для этого устройства, отформатирован неправильно. Дважды проверьте хэш оборудования, а затем повторите отправляются. |
| Устройство уже зарегистрировано | Это устройство уже зарегистрировано в вашей организации. Дальнейшие действия не требуются. |
| Устройство заявлено другой организацией | Это устройство уже заявлено другой организацией. Обратитесь к поставщику устройства. |
| Непредвиденная ошибка | Не удалось автоматически обработать запрос. Обратитесь в службу поддержки и введите идентификатор запроса:<requestId> |

### <a name="check-the-image"></a>Проверка изображения

Если ваше устройство поступило от поставщика управляемого партнера Майкрософт для настольных ПК, изображение должно быть правильным.

Вы также можете применить образ самостоятельно, если хотите. Чтобы приступить к работе, обратитесь к представителю Майкрософт, с которым вы работаете, и укажите расположение и действия по применению образа.

### <a name="deliver-the-device"></a>Доставка устройства

> [!IMPORTANT]
> Прежде чем вы перейдете на устройство для пользователя, убедитесь, что вы получили и применили [соответствующие лицензии](../get-ready/prerequisites.md) для этого пользователя.

Если все лицензии применяются, вы можете [приступить к работе с устройствами](get-started-devices.md), а затем, когда пользователь сможет запустить устройство и выполнить установку Windows.









